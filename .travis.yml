os: linux

language: clojure

jdk:
  - openjdk11

env:
  global:
    # AWS_ACCESS_KEY_ID
    - secure: "IH1Xc+jusFIPgx6hfXR7hJ+FtiHI3SRwn2ULU6RtfcJM4Lleborxj/9WiD79GtFQSjpfy139nsiayQXY1RYqOCSriMgm2ywmwLFCJVvn8UwZlc4nStCu3UomukoxsKUsVHWLcpzyEd4ojkKv3si9pabtN9mP6PhpRfk3UFabhedgEU1JD0PJBndKJ52wZgMMSY8+j+l9xuX8uuxGIDE4qI4znZ5powqeit1IFrqtsnTYKrpZ979Shu/PKXSggHxfoE8qCjOb5203zqcsK2D1g+5gEdpQvWO9T0D01IuxvA1s32eGEU9+JqwAI7Zk3xhumnn801kekgtpoEoWpCvYVf74mQRAsvcj0HTFtDfs2lLQ4dujNtc4jtSglHGQp/IbFyEWiq43eMjH5KA8MXAlQaW3kFnG965/7sOk2qHIBXCzNYTK2xIndDcMizTKjVz2GncA9XIKiInQ38xrJo0enUEH++hbmiuD3VU+knEX4y+iiuiHBQHWoqdzKxYJn6ucGcoPjYekU6yFim2foHkSOi+vMtewChTKm/ZdBsIn388BXAulHKJKc9IHXHO+8xrOAPQKKx/Kt0TReTILdpKbbQC1asDsEQsWGqJzqBVSZ/9zpeQsS3x9zXU32hgP30P2a2M1J6JBj+hHGhe/1vYRpCFmXScRqRAPfa5KZ5FSDLk="
    # AWS_SECRET_ACCESS_KEY
    - secure: "VTGMRnGzsrA7DMOKjkSEXVti0Y37+IMKljp7IwTu/96wbFsZldaZ9qGyxwpq2VdOF6jt/krlEBvQrq8CiKBgY452TLo8s2b0DlrH1aEzuNos4OO7V02J40kUWtmT4MjnAyOmuppGPC4xoxI+D4o2x5xQBOK40md5oZStmom/Ff3oie043b4n8GRGE64uwPcysGhouGp6nmyhPV1OGx0mVlDItrXf6ZMCi4xwapinumewvxZnY1iEcXVC8p6YQ/SU0dD8x3bsRLneINPB85vWCanwp+BdZAXGyYdOjVtgBTk+1I73UATbR3aBE/c8BiYVSkFSCdkgDjKDZ1jkY/qJiG/cDFjXxmcCNg7AgL5g+P9jBQIoXMkN69EJwdu2RcbP6/AbgzboJkQET9fUw08cxC9TieEaBrM1gaUL+gXT+MSpSXs2nATvm0bB7AWfXvC+Nr1yxhrrb1KC8J0J3pv8BNsHRzUeZgNVRFWEpT5MBGXKJ4Tx3R7OwotKXpd9cSvrrH/XbINh2IZeOg7w97HubZYMtlkiwgXI1+k9IHedTTR0ZTetqhQ2WEw+Ui6lPG8+fZ78r6C/pu2t0/QqU+2wzIGC54GFGyu+sKgH2BalEsQNO0Q+kYUX2X0hACUShXvwPJCTo/qG2gIgIhwOypO6n8oqFmtSjNb9spaD5fRKreI="
    - CONFIG="oph-configuration/test-travis.edn"

install:
  - git clone https://github.com/Opetushallitus/ci-tools.git
  - source ci-tools/common/setup-tools.sh
  - lein deps

before_script:
  - ./scripts/travis-scripts/run_postgres.sh

script:
  - mkdir -p resources/uberjar
  - ARTIFACT_NAME=ehoks-oppija BUILD_ID="ci-$TRAVIS_BUILD_NUMBER" ./scripts/buildversion.sh > resources/uberjar/buildversion.txt
  - lein checkall
  - lein test
  - lein uberjar
  - mv target/ehoks-standalone.jar $DOCKER_BUILD_DIR/artifact/ehoks-oppija.jar
  - cp -vr oph-configuration $DOCKER_BUILD_DIR/config/
  - export BASE_IMAGE="baseimage-fatjar-openjdk11:master"
  - ./ci-tools/common/pull-image.sh
  - ./ci-tools/build/build-fatjar.sh ehoks-oppija
  - mv $DOCKER_BUILD_DIR/artifact/ehoks-oppija.jar $DOCKER_BUILD_DIR/artifact/ehoks-virkailija.jar
  - ./ci-tools/build/build-fatjar.sh ehoks-virkailija

deploy:
  provider: script
  script: >-
    ./ci-tools/build/upload-image.sh ehoks-oppija &&
    ./ci-tools/build/upload-image.sh ehoks-virkailija &&
    lein dbmigrate
  on:
    all_branches: true

cache:
  directories:
    - "$HOME/.m2"
